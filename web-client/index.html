<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Friday</title>
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #1a1a2e;
    --border: #2a2a3e;
    --text: #e0e0e0;
    --dim: #666;
    --purple: #b48ead;
    --blue: #5dade2;
    --teal: #50c8a8;
    --orange: #e8a87c;
    --red: #e06c75;
    --pink: #e8738a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* ── Header ────────────────────────────────── */

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }

  .logo {
    font-size: 18px;
    font-weight: 600;
    color: var(--purple);
  }

  .logo span {
    color: var(--dim);
    font-weight: 400;
    font-size: 13px;
    margin-left: 8px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--red);
    display: inline-block;
  }

  .status-dot.connected {
    background: var(--teal);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-right button {
    background: none;
    border: 1px solid var(--border);
    color: var(--dim);
    padding: 4px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
  }

  .header-right button:hover {
    border-color: var(--purple);
    color: var(--text);
  }

  /* ── Messages ──────────────────────────────── */

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .message {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    line-height: 1.6;
  }

  .message.user {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px 16px;
  }

  .message.user .label {
    color: var(--purple);
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .message.assistant {
    padding: 4px 0;
  }

  .message.assistant .label {
    color: var(--teal);
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .message .content {
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .message .content code {
    background: rgba(255,255,255,0.06);
    padding: 1px 5px;
    border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 0.9em;
  }

  .message .content pre {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    overflow-x: auto;
    margin: 8px 0;
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
  }

  .message.system {
    color: var(--dim);
    font-size: 13px;
    text-align: center;
    font-style: italic;
  }

  .message.error {
    color: var(--red);
    font-size: 13px;
  }

  /* ── Tool use indicator ────────────────────── */

  .tool-indicator {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--dim);
    font-size: 13px;
    padding: 4px 0;
  }

  .tool-indicator .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--purple);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Permission request ────────────────────── */

  .permission-request {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    background: var(--surface);
    border: 1px solid var(--orange);
    border-radius: 12px;
    padding: 16px;
  }

  .permission-request h4 {
    color: var(--orange);
    font-size: 14px;
    margin-bottom: 8px;
  }

  .permission-request .details {
    color: var(--dim);
    font-size: 13px;
    margin-bottom: 12px;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  .permission-request .actions {
    display: flex;
    gap: 8px;
  }

  .permission-request button {
    padding: 6px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
  }

  .btn-allow {
    background: var(--teal);
    color: #000;
  }

  .btn-deny {
    background: transparent;
    border: 1px solid var(--border) !important;
    color: var(--dim);
  }

  .btn-deny:hover {
    border-color: var(--red) !important;
    color: var(--red);
  }

  /* ── Cost line ─────────────────────────────── */

  .cost-line {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    color: var(--dim);
    font-size: 12px;
    padding: 2px 0;
  }

  /* ── Input ─────────────────────────────────── */

  #input-area {
    border-top: 1px solid var(--border);
    background: var(--surface);
    padding: 16px 20px;
  }

  #input-area form {
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }

  #input-area textarea {
    flex: 1;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    padding: 10px 14px;
    font-size: 15px;
    font-family: inherit;
    resize: none;
    min-height: 44px;
    max-height: 200px;
    outline: none;
  }

  #input-area textarea:focus {
    border-color: var(--purple);
  }

  #input-area button[type="submit"] {
    background: var(--purple);
    border: none;
    color: #000;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    white-space: nowrap;
  }

  #input-area button[type="submit"]:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* ── Thinking indicator ────────────────────── */
  .thinking {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--dim);
    font-size: 13px;
    padding: 8px 0;
  }

  .thinking .dots span {
    animation: blink 1.4s infinite both;
  }
  .thinking .dots span:nth-child(2) { animation-delay: 0.2s; }
  .thinking .dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes blink { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }
</style>
</head>
<body>

<header>
  <div class="logo">
    friday <span>v0.2.0</span>
  </div>
  <div class="header-right">
    <button id="btn-new">New Session</button>
    <span class="status-dot" id="status-dot" title="Disconnected"></span>
  </div>
</header>

<div id="messages"></div>

<div id="input-area">
  <form id="chat-form">
    <textarea id="user-input" rows="1" placeholder="Message Friday..." autofocus></textarea>
    <button type="submit" id="send-btn">Send</button>
  </form>
</div>

<script>
// ── State ──────────────────────────────────────
let ws = null;
let sessionId = null;
let currentAssistantEl = null;
let isStreaming = false;
let pendingPermission = null;

const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('user-input');
const formEl = document.getElementById('chat-form');
const sendBtn = document.getElementById('send-btn');
const statusDot = document.getElementById('status-dot');
const btnNew = document.getElementById('btn-new');

// ── WebSocket ──────────────────────────────────

function connect() {
  const host = location.hostname || 'localhost';
  const port = 8787;
  ws = new WebSocket(`ws://${host}:${port}/ws`);

  ws.onopen = () => {
    statusDot.classList.add('connected');
    statusDot.title = 'Connected';
  };

  ws.onclose = () => {
    statusDot.classList.remove('connected');
    statusDot.title = 'Disconnected';
    addSystemMessage('Disconnected. Reconnecting...');
    setTimeout(connect, 2000);
  };

  ws.onerror = () => {
    // onclose will fire after this
  };

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleMessage(msg);
    } catch (e) {
      console.error('Failed to parse message:', e);
    }
  };
}

function send(payload) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(payload));
  }
}

// ── Message handler ────────────────────────────

function handleMessage(msg) {
  switch (msg.type) {
    case 'ready':
      addSystemMessage('Connected to Friday runtime.');
      break;

    case 'session':
      sessionId = msg.session_id;
      break;

    case 'thinking':
      showThinking();
      break;

    case 'thinking_complete':
      break;

    case 'chunk':
      hideThinking();
      hideToolIndicator();
      appendChunk(msg.text || msg.content || '');
      break;

    case 'tool_use':
      hideThinking();
      finalizeAssistant();
      showToolIndicator(msg.tool_name, msg.tool_input);
      break;

    case 'tool_result':
      break;

    case 'permission_request':
      hideThinking();
      hideToolIndicator();
      showPermissionRequest(msg);
      break;

    case 'permission_cancelled':
      removePermissionRequest(msg.permission_id);
      break;

    case 'error':
      hideThinking();
      hideToolIndicator();
      addErrorMessage(msg.message);
      enableInput();
      break;

    case 'complete':
      hideThinking();
      hideToolIndicator();
      finalizeAssistant();
      if (msg.cost && msg.cost.estimated > 0) {
        showCost(msg.cost);
      }
      enableInput();
      break;

    case 'info':
      // suppress in clean mode
      break;

    default:
      break;
  }
}

// ── DOM helpers ────────────────────────────────

function addUserMessage(text) {
  const el = document.createElement('div');
  el.className = 'message user';
  el.innerHTML = `<div class="label">You</div><div class="content"></div>`;
  el.querySelector('.content').textContent = text;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function ensureAssistantEl() {
  if (!currentAssistantEl) {
    currentAssistantEl = document.createElement('div');
    currentAssistantEl.className = 'message assistant';
    currentAssistantEl.innerHTML = `<div class="label">Friday</div><div class="content"></div>`;
    messagesEl.appendChild(currentAssistantEl);
  }
  return currentAssistantEl.querySelector('.content');
}

function appendChunk(text) {
  const contentEl = ensureAssistantEl();
  contentEl.textContent += text;
  isStreaming = true;
  scrollToBottom();
}

function finalizeAssistant() {
  if (currentAssistantEl) {
    // Render markdown-ish content (code blocks)
    const contentEl = currentAssistantEl.querySelector('.content');
    const raw = contentEl.textContent;
    contentEl.innerHTML = renderMarkdown(raw);
  }
  currentAssistantEl = null;
  isStreaming = false;
}

function addSystemMessage(text) {
  const el = document.createElement('div');
  el.className = 'message system';
  el.textContent = text;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function addErrorMessage(text) {
  const el = document.createElement('div');
  el.className = 'message error';
  el.textContent = 'Error: ' + text;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function showThinking() {
  if (document.getElementById('thinking-indicator')) return;
  const el = document.createElement('div');
  el.className = 'thinking';
  el.id = 'thinking-indicator';
  el.innerHTML = `<div class="dots"><span>.</span><span>.</span><span>.</span></div> Thinking`;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function hideThinking() {
  const el = document.getElementById('thinking-indicator');
  if (el) el.remove();
}

function showToolIndicator(toolName, toolInput) {
  hideToolIndicator();
  const desc = humanizeTool(toolName, toolInput);
  const el = document.createElement('div');
  el.className = 'tool-indicator';
  el.id = 'tool-indicator';
  el.innerHTML = `<div class="spinner"></div> ${escapeHtml(desc)}`;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function hideToolIndicator() {
  const el = document.getElementById('tool-indicator');
  if (el) el.remove();
}

function showPermissionRequest(msg) {
  pendingPermission = msg;
  const el = document.createElement('div');
  el.className = 'permission-request';
  el.id = `perm-${msg.permission_id}`;

  let details = '';
  if (msg.tool_input) {
    const entries = Object.entries(msg.tool_input).slice(0, 3);
    details = entries.map(([k, v]) => {
      const val = typeof v === 'string' ? v : JSON.stringify(v);
      return `${k}: ${val.length > 80 ? val.slice(0, 77) + '...' : val}`;
    }).join('\n');
  }

  el.innerHTML = `
    <h4>Permission needed: ${escapeHtml(msg.description || msg.tool_name)}</h4>
    ${details ? `<div class="details"><pre>${escapeHtml(details)}</pre></div>` : ''}
    <div class="actions">
      <button class="btn-allow" onclick="respondPermission('${msg.permission_id}', true)">Allow</button>
      <button class="btn-allow" onclick="respondPermission('${msg.permission_id}', true, 'session')">Allow for session</button>
      <button class="btn-deny" onclick="respondPermission('${msg.permission_id}', false)">Deny</button>
    </div>
  `;
  messagesEl.appendChild(el);
  scrollToBottom();
}

function removePermissionRequest(permId) {
  const el = document.getElementById(`perm-${permId}`);
  if (el) el.remove();
}

window.respondPermission = function(permId, approved, level) {
  const payload = {
    type: 'permission_response',
    permission_id: permId,
    approved,
  };
  if (level) payload.permission_level = level;
  send(payload);
  removePermissionRequest(permId);
  pendingPermission = null;
};

function showCost(cost) {
  const amount = cost.estimated;
  const costStr = amount < 0.01 ? `${(amount * 100).toFixed(2)}c` : `$${amount.toFixed(4)}`;
  const tokens = cost.tokens ? `${cost.tokens.input + cost.tokens.output} tokens` : '';
  const el = document.createElement('div');
  el.className = 'cost-line';
  el.textContent = `${costStr}${tokens ? ' · ' + tokens : ''}`;
  messagesEl.appendChild(el);
}

function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function enableInput() {
  inputEl.disabled = false;
  sendBtn.disabled = false;
  inputEl.focus();
}

function disableInput() {
  sendBtn.disabled = true;
}

// ── Rendering helpers ──────────────────────────

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function renderMarkdown(text) {
  // Simple code block rendering
  let html = escapeHtml(text);
  // Fenced code blocks: ```lang\n...\n```
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
    return `<pre><code>${code}</code></pre>`;
  });
  // Inline code: `...`
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Bold: **...**
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  return html;
}

function humanizeTool(name, input) {
  if (!name) return 'Working...';
  const parts = name.split('__');
  const action = parts[parts.length - 1];
  const map = {
    read_file: () => `Reading ${input?.path ? input.path.split('/').pop() : 'file'}`,
    write_file: () => `Writing ${input?.path ? input.path.split('/').pop() : 'file'}`,
    execute_command: () => `Running: ${(input?.command || '').slice(0, 60)}`,
    bash: () => `Running: ${(input?.command || '').slice(0, 60)}`,
    search_files: () => 'Searching files',
    list_directory: () => 'Listing directory',
  };
  if (map[action]) return map[action]();
  return action.replace(/_/g, ' ');
}

// ── Auto-resize textarea ───────────────────────

inputEl.addEventListener('input', () => {
  inputEl.style.height = 'auto';
  inputEl.style.height = Math.min(inputEl.scrollHeight, 200) + 'px';
});

// Enter to send, Shift+Enter for newline
inputEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    formEl.dispatchEvent(new Event('submit'));
  }
});

// ── Form submit ────────────────────────────────

formEl.addEventListener('submit', (e) => {
  e.preventDefault();
  const text = inputEl.value.trim();
  if (!text) return;

  addUserMessage(text);
  disableInput();
  inputEl.value = '';
  inputEl.style.height = 'auto';

  send({ type: 'query', message: text, session_id: sessionId });
});

// ── New session ────────────────────────────────

btnNew.addEventListener('click', () => {
  sessionId = null;
  send({ type: 'new_session' });
  messagesEl.innerHTML = '';
  addSystemMessage('New session started.');
  inputEl.focus();
});

// ── Boot ───────────────────────────────────────

connect();
</script>
</body>
</html>
